# API Documentation

This document provides complete REST endpoint specifications for the JamLoop Campaign Management System, using crudcrud.com as the data persistence layer.

---

## **Base Configuration**

### **Environment Variables**

```env
NEXT_PUBLIC_CRUDCRUD_ENDPOINT=https://crudcrud.com/api/7a9ddccaf6e347b7b161e8c1a4d8c394
```

### **Base URL**

```
https://crudcrud.com/api/7a9ddccaf6e347b7b161e8c1a4d8c394
```

All campaign endpoints are prefixed with `/campaigns`.

---

## **Authentication**

### **Client-Side Simulation (PoC)**

This PoC uses **simulated authentication** with hardcoded credentials:

| Username | Password | user_id |
|----------|----------|---------|
| `user_A` | `password_A` | `user_A` |
| `user_B` | `password_B` | `user_B` |

The active `user_id` is stored in `localStorage` and automatically injected into all write operations.

**Note**: Production systems require server-side authentication with proper token management.

---

## **Data Model**

### **Campaign Schema**

```typescript
interface Campaign {
  _id: string;                    // Auto-generated by crudcrud.com
  user_id: string;                // "user_A" or "user_B"
  campaign_name: string;          // Min 3 characters
  budget_goal_usd: number;        // Must be > 0
  start_date: string;             // ISO 8601 date (YYYY-MM-DD)
  end_date: string;               // ISO 8601 date (YYYY-MM-DD)
  target_age_min: number;         // 18-99
  target_age_max: number;         // 18-99
  target_gender: string;          // "Male" | "Female" | "All"
  geo_countries: string[];        // ["USA", "Canada", ...]
  geo_states: string[];           // ["California", "Texas", ...]
  geo_cities: string[];           // ["Los Angeles", "Houston", ...]
  geo_zip_codes: string[];        // ["90001", "77001", ...]
  inventory: string[];            // ["Hulu", "Discovery", ...]
  screens: string[];              // ["CTV", "Mobile Device", ...]
}
```

### **Example Campaign Object**

```json
{
  "_id": "65a1b2c3d4e5f6g7h8i9j0k1",
  "user_id": "user_A",
  "campaign_name": "Summer Ad Launch 2025",
  "budget_goal_usd": 50000.00,
  "start_date": "2025-06-01",
  "end_date": "2025-08-31",
  "target_age_min": 25,
  "target_age_max": 54,
  "target_gender": "All",
  "geo_countries": ["USA", "Canada"],
  "geo_states": ["California", "Texas"],
  "geo_cities": ["Los Angeles", "Houston"],
  "geo_zip_codes": ["90001", "77001"],
  "inventory": ["Hulu", "Discovery", "ABC"],
  "screens": ["CTV", "Mobile Device"]
}
```

---

## **Endpoints**

### **1. Get All Campaigns**

Retrieves all campaigns from the database. **Client-side filtering** is required to show only the logged-in user's campaigns.

**Endpoint:**
```
GET /campaigns
```

**Request:**
```bash
curl -X GET https://crudcrud.com/api/7a9ddccaf6e347b7b161e8c1a4d8c394/campaigns
```

**Response: 200 OK**
```json
[
  {
    "_id": "65a1b2c3d4e5f6g7h8i9j0k1",
    "user_id": "user_A",
    "campaign_name": "Summer Ad Launch",
    "budget_goal_usd": 50000,
    "start_date": "2025-06-01",
    "end_date": "2025-08-31",
    "target_age_min": 25,
    "target_age_max": 54,
    "target_gender": "All",
    "geo_countries": ["USA"],
    "geo_states": ["California"],
    "geo_cities": ["Los Angeles"],
    "geo_zip_codes": ["90001"],
    "inventory": ["Hulu", "Discovery"],
    "screens": ["CTV"]
  },
  {
    "_id": "75b2c3d4e5f6g7h8i9j0k1l2",
    "user_id": "user_B",
    "campaign_name": "Holiday Campaign",
    "budget_goal_usd": 75000,
    "start_date": "2025-11-01",
    "end_date": "2025-12-31",
    "target_age_min": 18,
    "target_age_max": 65,
    "target_gender": "Female",
    "geo_countries": ["USA", "Canada"],
    "geo_states": ["New York", "Ontario"],
    "geo_cities": ["New York City", "Toronto"],
    "geo_zip_codes": ["10001", "M5H"],
    "inventory": ["ABC", "Fox News"],
    "screens": ["CTV", "Mobile Device", "Web Browser"]
  }
]
```

**Client-Side Filtering Example:**
```typescript
const allCampaigns = await getCampaigns();
const userId = getActiveUserId(); // "user_A" or "user_B"
const userCampaigns = allCampaigns.filter(c => c.user_id === userId);
```

**Error Response: 404 Not Found**
```json
{
  "message": "Resource not found"
}
```

---

### **2. Get Campaign by ID**

Retrieves a specific campaign by its unique ID.

**Endpoint:**
```
GET /campaigns/:id
```

**Request:**
```bash
curl -X GET https://crudcrud.com/api/7a9ddccaf6e347b7b161e8c1a4d8c394/campaigns/65a1b2c3d4e5f6g7h8i9j0k1
```

**Response: 200 OK**
```json
{
  "_id": "65a1b2c3d4e5f6g7h8i9j0k1",
  "user_id": "user_A",
  "campaign_name": "Summer Ad Launch",
  "budget_goal_usd": 50000,
  "start_date": "2025-06-01",
  "end_date": "2025-08-31",
  "target_age_min": 25,
  "target_age_max": 54,
  "target_gender": "All",
  "geo_countries": ["USA"],
  "geo_states": ["California"],
  "geo_cities": ["Los Angeles"],
  "geo_zip_codes": ["90001"],
  "inventory": ["Hulu", "Discovery"],
  "screens": ["CTV"]
}
```

**Client-Side Security Check:**
```typescript
const campaign = await getCampaignById(id);
const userId = getActiveUserId();

if (campaign.user_id !== userId) {
  // Redirect or show error - user doesn't own this campaign
  throw new Error('Unauthorized access');
}
```

**Error Response: 404 Not Found**
```json
{
  "message": "Campaign not found"
}
```

---

### **3. Create Campaign**

Creates a new campaign. The `user_id` is automatically injected based on the logged-in user.

**Endpoint:**
```
POST /campaigns
```

**Request Headers:**
```
Content-Type: application/json
```

**Request Body:**
```json
{
  "user_id": "user_A",
  "campaign_name": "Fall Campaign 2025",
  "budget_goal_usd": 100000,
  "start_date": "2025-09-01",
  "end_date": "2025-11-30",
  "target_age_min": 30,
  "target_age_max": 60,
  "target_gender": "All",
  "geo_countries": ["USA", "Canada"],
  "geo_states": ["California", "Texas", "Ontario"],
  "geo_cities": ["San Francisco", "Austin", "Toronto"],
  "geo_zip_codes": ["94102", "78701", "M5H"],
  "inventory": ["Hulu", "ABC", "TLC"],
  "screens": ["CTV", "Mobile Device"]
}
```

**Request Example:**
```bash
curl -X POST https://crudcrud.com/api/7a9ddccaf6e347b7b161e8c1a4d8c394/campaigns \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "user_A",
    "campaign_name": "Fall Campaign 2025",
    "budget_goal_usd": 100000,
    "start_date": "2025-09-01",
    "end_date": "2025-11-30",
    "target_age_min": 30,
    "target_age_max": 60,
    "target_gender": "All",
    "geo_countries": ["USA", "Canada"],
    "geo_states": ["California", "Texas"],
    "geo_cities": ["San Francisco", "Austin"],
    "geo_zip_codes": ["94102", "78701"],
    "inventory": ["Hulu", "ABC"],
    "screens": ["CTV", "Mobile Device"]
  }'
```

**Response: 201 Created**
```json
{
  "_id": "85c3d4e5f6g7h8i9j0k1l2m3",
  "user_id": "user_A",
  "campaign_name": "Fall Campaign 2025",
  "budget_goal_usd": 100000,
  "start_date": "2025-09-01",
  "end_date": "2025-11-30",
  "target_age_min": 30,
  "target_age_max": 60,
  "target_gender": "All",
  "geo_countries": ["USA", "Canada"],
  "geo_states": ["California", "Texas"],
  "geo_cities": ["San Francisco", "Austin"],
  "geo_zip_codes": ["94102", "78701"],
  "inventory": ["Hulu", "ABC"],
  "screens": ["CTV", "Mobile Device"]
}
```

**Validation Rules (Client-Side):**

| Field | Rule | Error Message |
|-------|------|---------------|
| `campaign_name` | Min 3 characters | "Campaign name must be at least 3 characters" |
| `budget_goal_usd` | Must be > 0 | "Budget must be greater than 0" |
| `start_date` | Must be today or future | "Start date must be today or in the future" |
| `end_date` | Must be after `start_date` | "End date must be after start date" |
| `target_age_min` | 18-99 | "Minimum age must be between 18 and 99" |
| `target_age_max` | 18-99, must be ≥ `target_age_min` | "Maximum age must be between 18 and 99" / "Minimum age cannot exceed maximum age" |
| `geo_countries` | At least 1 selection | "Please select at least one country" |
| `inventory` | At least 1 selection | "Please select at least one publisher" |
| `screens` | At least 1 selection | "Please select at least one device type" |

**Error Response: 400 Bad Request**
```json
{
  "message": "Invalid request body"
}
```

---

### **4. Update Campaign**

Updates an existing campaign. The `user_id` must remain unchanged and match the logged-in user.

**Endpoint:**
```
PUT /campaigns/:id
```

**Request Headers:**
```
Content-Type: application/json
```

**Request Body:**
```json
{
  "user_id": "user_A",
  "campaign_name": "Updated Summer Campaign",
  "budget_goal_usd": 60000,
  "start_date": "2025-06-01",
  "end_date": "2025-09-15",
  "target_age_min": 25,
  "target_age_max": 54,
  "target_gender": "All",
  "geo_countries": ["USA", "Canada", "Mexico"],
  "geo_states": ["California", "Texas", "Quebec"],
  "geo_cities": ["Los Angeles", "Houston", "Montreal"],
  "geo_zip_codes": ["90001", "77001", "H3A"],
  "inventory": ["Hulu", "Discovery", "ABC", "Fox Sports"],
  "screens": ["CTV", "Mobile Device", "Web Browser"]
}
```

**Request Example:**
```bash
curl -X PUT https://crudcrud.com/api/7a9ddccaf6e347b7b161e8c1a4d8c394/campaigns/65a1b2c3d4e5f6g7h8i9j0k1 \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "user_A",
    "campaign_name": "Updated Summer Campaign",
    "budget_goal_usd": 60000,
    "start_date": "2025-06-01",
    "end_date": "2025-09-15",
    "target_age_min": 25,
    "target_age_max": 54,
    "target_gender": "All",
    "geo_countries": ["USA", "Canada"],
    "geo_states": ["California"],
    "geo_cities": ["Los Angeles"],
    "geo_zip_codes": ["90001"],
    "inventory": ["Hulu", "Discovery", "ABC"],
    "screens": ["CTV", "Mobile Device"]
  }'
```

**Response: 200 OK**
```json
{
  "_id": "65a1b2c3d4e5f6g7h8i9j0k1",
  "user_id": "user_A",
  "campaign_name": "Updated Summer Campaign",
  "budget_goal_usd": 60000,
  "start_date": "2025-06-01",
  "end_date": "2025-09-15",
  "target_age_min": 25,
  "target_age_max": 54,
  "target_gender": "All",
  "geo_countries": ["USA", "Canada"],
  "geo_states": ["California"],
  "geo_cities": ["Los Angeles"],
  "geo_zip_codes": ["90001"],
  "inventory": ["Hulu", "Discovery", "ABC"],
  "screens": ["CTV", "Mobile Device"]
}
```

**Client-Side Security Check:**
```typescript
// Before updating, verify ownership
const existingCampaign = await getCampaignById(id);
const userId = getActiveUserId();

if (existingCampaign.user_id !== userId) {
  throw new Error('Unauthorized: Cannot update another user\'s campaign');
}

// Ensure user_id is not changed
const updatedData = {
  ...formData,
  user_id: userId // Force correct user_id
};

await updateCampaign(id, updatedData);
```

**Error Response: 404 Not Found**
```json
{
  "message": "Campaign not found"
}
```

---

### **5. Delete Campaign**

Deletes a campaign by ID. Client-side verification ensures the user owns the campaign.

**Endpoint:**
```
DELETE /campaigns/:id
```

**Request:**
```bash
curl -X DELETE https://crudcrud.com/api/7a9ddccaf6e347b7b161e8c1a4d8c394/campaigns/65a1b2c3d4e5f6g7h8i9j0k1
```

**Response: 200 OK**
```json
{
  "message": "Campaign deleted successfully"
}
```

**Client-Side Security Check:**
```typescript
// Before deleting, verify ownership
const campaign = await getCampaignById(id);
const userId = getActiveUserId();

if (campaign.user_id !== userId) {
  throw new Error('Unauthorized: Cannot delete another user\'s campaign');
}

await deleteCampaign(id);
```

**Error Response: 404 Not Found**
```json
{
  "message": "Campaign not found"
}
```

---

## **API Client Implementation**

### **File: `lib/api/campaigns.ts`**

```typescript
const API_BASE_URL = process.env.NEXT_PUBLIC_CRUDCRUD_ENDPOINT;

/**
 * Fetches all campaigns from the API
 * Note: Client-side filtering required to show only user's campaigns
 */
export async function getCampaigns(): Promise<Campaign[]> {
  const response = await fetch(`${API_BASE_URL}/campaigns`);
  
  if (!response.ok) {
    throw new Error('Failed to fetch campaigns');
  }
  
  return response.json();
}

/**
 * Fetches a single campaign by ID
 */
export async function getCampaignById(id: string): Promise<Campaign> {
  const response = await fetch(`${API_BASE_URL}/campaigns/${id}`);
  
  if (!response.ok) {
    throw new Error('Campaign not found');
  }
  
  return response.json();
}

/**
 * Creates a new campaign
 * Note: user_id is auto-injected from session
 */
export async function createCampaign(
  campaign: Omit<Campaign, '_id'>
): Promise<Campaign> {
  const response = await fetch(`${API_BASE_URL}/campaigns`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(campaign),
  });
  
  if (!response.ok) {
    throw new Error('Failed to create campaign');
  }
  
  return response.json();
}

/**
 * Updates an existing campaign
 * Note: user_id must match logged-in user
 */
export async function updateCampaign(
  id: string,
  campaign: Omit<Campaign, '_id'>
): Promise<Campaign> {
  const response = await fetch(`${API_BASE_URL}/campaigns/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(campaign),
  });
  
  if (!response.ok) {
    throw new Error('Failed to update campaign');
  }
  
  return response.json();
}

/**
 * Deletes a campaign by ID
 */
export async function deleteCampaign(id: string): Promise<void> {
  const response = await fetch(`${API_BASE_URL}/campaigns/${id}`, {
    method: 'DELETE',
  });
  
  if (!response.ok) {
    throw new Error('Failed to delete campaign');
  }
}
```

---

## **Error Handling**

### **Standard Error Responses**

| Status Code | Description | Common Causes |
|-------------|-------------|---------------|
| **200 OK** | Request successful | - |
| **201 Created** | Resource created successfully | POST successful |
| **400 Bad Request** | Invalid request format | Malformed JSON, missing required fields |
| **404 Not Found** | Resource not found | Invalid ID, resource deleted |
| **500 Internal Server Error** | Server error | crudcrud.com service issue |

### **Client-Side Error Handling Pattern**

```typescript
try {
  setIsLoading(true);
  const campaign = await getCampaignById(id);
  
  // Security check
  if (campaign.user_id !== getActiveUserId()) {
    toast.error('You do not have permission to access this campaign');
    router.push('/dashboard');
    return;
  }
  
  setCampaign(campaign);
} catch (error) {
  console.error('Error loading campaign:', error);
  toast.error('Failed to load campaign. Please try again.');
} finally {
  setIsLoading(false);
}
```

---

## **crudcrud.com Specifics**

### **Auto-Generated IDs**

crudcrud.com automatically generates a unique `_id` field (MongoDB ObjectId format) for each record:

```json
{
  "_id": "65a1b2c3d4e5f6g7h8i9j0k1",
  // ... other fields
}
```

You **do not** need to generate IDs client-side.

### **Data Retention**

- Data persists for **24 hours** (typical duration for free tier)
- Sufficient for development and testing
- No concern for data loss during implementation phase

### **No Authentication Required**

- No API keys or tokens needed
- Public endpoint (suitable for PoC only)
- Production systems require proper authentication

### **CORS Enabled**

- crudcrud.com has CORS enabled by default
- Client-side requests work without additional configuration

### **Rate Limits**

- Free tier has generous rate limits for development
- No special handling required for this PoC

---

## **Testing the API**

### **Using curl**

```bash
# Get all campaigns
curl -X GET https://crudcrud.com/api/7a9ddccaf6e347b7b161e8c1a4d8c394/campaigns

# Create a campaign
curl -X POST https://crudcrud.com/api/7a9ddccaf6e347b7b161e8c1a4d8c394/campaigns \
  -H "Content-Type: application/json" \
  -d '{"user_id":"user_A","campaign_name":"Test Campaign","budget_goal_usd":10000,"start_date":"2025-06-01","end_date":"2025-08-31","target_age_min":25,"target_age_max":54,"target_gender":"All","geo_countries":["USA"],"geo_states":[],"geo_cities":[],"geo_zip_codes":[],"inventory":["Hulu"],"screens":["CTV"]}'

# Get campaign by ID (replace with actual ID)
curl -X GET https://crudcrud.com/api/7a9ddccaf6e347b7b161e8c1a4d8c394/campaigns/65a1b2c3d4e5f6g7h8i9j0k1

# Update campaign (replace with actual ID)
curl -X PUT https://crudcrud.com/api/7a9ddccaf6e347b7b161e8c1a4d8c394/campaigns/65a1b2c3d4e5f6g7h8i9j0k1 \
  -H "Content-Type: application/json" \
  -d '{"user_id":"user_A","campaign_name":"Updated Campaign","budget_goal_usd":15000,"start_date":"2025-06-01","end_date":"2025-09-30","target_age_min":25,"target_age_max":54,"target_gender":"All","geo_countries":["USA"],"geo_states":[],"geo_cities":[],"geo_zip_codes":[],"inventory":["Hulu"],"screens":["CTV"]}'

# Delete campaign (replace with actual ID)
curl -X DELETE https://crudcrud.com/api/7a9ddccaf6e347b7b161e8c1a4d8c394/campaigns/65a1b2c3d4e5f6g7h8i9j0k1
```

### **Using Postman**

Import this collection to test endpoints:

1. Create a new collection: "JamLoop CMS API"
2. Set base URL variable: `{{baseUrl}}` = `https://crudcrud.com/api/7a9ddccaf6e347b7b161e8c1a4d8c394`
3. Add requests for each endpoint above
4. Test data isolation by creating campaigns with different `user_id` values

---

## **Reference Links**

- **crudcrud.com Documentation**: [https://crudcrud.com](https://crudcrud.com)
- **Project Requirements**: [docs/requirements.md](./requirements.md)
- **Code Style Guide**: [docs/style-guide.md](./style-guide.md)

---

**Note**: This API documentation reflects the PoC architecture with client-side data isolation. Production systems would implement server-side authentication, authorization, and proper API security.

---

## **UI Data Model Mapping**

| Field | Type | UI Control | Validation Rules | Notes |
| :---- | :---- | :---- | :---- | :---- |
| **campaign_name** | String | Text Input | Required, min 3 characters | Descriptive title for the campaign |
| **budget_goal_usd** | Number | Number Input | Required, must be > 0 | USD value (e.g., 50000.00) |
| **start_date** | Date | HTML5 Date Input (type="date") | Required, must be today or future | Campaign start date (YYYY-MM-DD) |
| **end_date** | Date | HTML5 Date Input (type="date") | Required, must be after start_date | Campaign end date (YYYY-MM-DD) |
| **target_age_min** | Number | Number Input | Required, must be 18-99, must be ≤ target_age_max | Minimum target age |
| **target_age_max** | Number | Number Input | Required, must be 18-99, must be ≥ target_age_min | Maximum target age |
| **target_gender** | String | Radio Buttons | Required | Options: "Male", "Female", "All" |
| **geo_countries** | Array[String] | Checkboxes | At least one selection required | Options: "USA", "Canada", "Mexico", "UK" |
| **geo_states** | Array[String] | Text Input (comma-separated) | Optional (empty array if none selected) | Example: "California, Texas, New York" |
| **geo_cities** | Array[String] | Text Input (comma-separated) | Optional (empty array if none selected) | Example: "Los Angeles, Houston, Chicago" |
| **geo_zip_codes** | Array[String] | Text Input (comma-separated) | Optional (empty array if none selected) | Example: "90001, 77001, 60601" |
| **inventory** | Array[String] | Checkboxes | At least one selection required | Options: "Hulu", "Discovery", "ABC", "A&E", "TLC", "Fox News", "Fox Sports" |
| **screens** | Array[String] | Checkboxes | At least one selection required | Options: "CTV", "Mobile Device", "Web Browser" |
| **user_id** | String | Hidden Field (auto-populated) | Auto-injected based on logged-in user | Not editable by user. Values: "user_A" or "user_B" |
